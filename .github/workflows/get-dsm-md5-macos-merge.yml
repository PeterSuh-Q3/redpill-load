name: result.json - Get Synology DSM MD5 (macOS) - Merged

on:
  workflow_dispatch:

jobs:
  Get-md5:
    runs-on: macos-latest
    strategy:  
      matrix:
        dsm:
          - version: '6.2.4-25556'
            nano: false
          - version: '7.0.1-42218'
            nano: false
          - version: '7.1.1-42962'
            nano: true
          - version: '7.2-64570'
            nano: true
          - version: '7.2.1-69057'
            nano: true
          - version: '7.2.2-72806'
            nano: false
          #- version: '7.3-81180'
          #  nano: false
          #- version: '7.3.1-86003'
          #  nano: false
          #- version: '7.3.2-86009'
          #  nano: false
          
    env:
      DSM_VERSION: ${{ matrix.dsm.version }}
      IS_NANO: ${{ matrix.dsm.nano }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      #- name: Install dependencies
      #  run: |
      #    brew install wget jq
      #    # macOS는 기본적으로 curl, md5 제공됨

      - name: Prepare md5list file
        run: |
          # DSM_VERSION_URL=7.2.2-72806
          DSM_VERSION_URL=$(echo "$DSM_VERSION" | sed 's/-/\//')

          if [ "$IS_NANO" = "true" ]; then
            ARCHIVE_URL="https://archive.synology.com/download/Os/DSM/${DSM_VERSION}-1-NanoPacked"
          else
            ARCHIVE_URL="https://archive.synology.com/download/Os/DSM/${DSM_VERSION}"
          fi
          
          echo "Fetching file list from $ARCHIVE_URL ..."
          
          # PAT 파일 목록 가져오기 -> URL 디코딩으로 정규화 -> 중복 제거 -> 상위 5개만
          curl -s "$ARCHIVE_URL" | \
            grep -oE 'DSM_[^"]+\.pat' | \
            sed 's/%2B/+/g' | \
            sort -u | \
            head -300 | \
            while read filename; do
              if [ "$IS_NANO" = "true" ]; then
                echo "https://global.synologydownload.com/download/DSM/release/${DSM_VERSION_URL}-1/$filename"
              else
                echo "https://global.synologydownload.com/download/DSM/release/${DSM_VERSION_URL}/$filename"
              fi
            done > md5list
          
          echo "Get md5list with $(wc -l < md5list) files:"
          head -5 md5list
      
          # 2차: config/model_list로 필터링
          #grep -F -f config/model_list md5list > md5list.filtered || true
          #mv md5list.filtered md5list
      
          #echo "Filtered md5list ($(wc -l < md5list) files):"
          #cat md5list

      - name: Run MD5 Generation Script
        run: |
          chmod +x ./config/get_md5_json_macos.sh
          # 만약 인자가 필요한 형태로 스크립트 수정이 필요하다면 아래처럼 사용하세요
          ./config/get_md5_json_macos.sh "$DSM_VERSION"
          # 기본 형태는 환경변수 DSM_VERSION을 활용하거나, 내부에서 md5list 읽도록 구현

      - name: Validate and Rename JSON
        run: |
          jq empty result.json
          echo "result.json validated."
          cp result.json "result-${{ env.DSM_VERSION }}.json"          

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: dsm-md5-${{ env.DSM_VERSION }}
          path: |
            result-${{ env.DSM_VERSION }}.json
            #md5list

  Merge-Results:
    needs: Get-md5
    runs-on: macos-latest
    
    steps:
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Debug - List downloaded files
        run: |
          echo "=== All downloaded files ==="
          find artifacts -type f -name "*.json" | sort -V
          echo ""
          echo "=== Directory structure ==="
          find artifacts -type d | head -20
          echo ""
          echo "=== Total JSON files ==="
          find artifacts -type f -name "*.json" | wc -l

      - name: Debug - Check individual file contents
        run: |
          echo "=== Checking first few files ==="
          find artifacts -type f -name "result-*.json" | sort -V | head -3 | while read FILE; do
            echo ""
            echo "File: $FILE"
            echo "Size: $(wc -c < "$FILE") bytes"
            echo "Keys count: $(jq 'keys | length' "$FILE")"
            echo "First model: $(jq 'keys[0]' "$FILE")"
          done

      - name: Merge all JSON files - MACOS COMPATIBLE
        run: |
          echo "=== Starting merge process ==="
          
          # 모든 파일 찾기 (배열 대신 변수 사용)
          FILE_COUNT=0
          FIRST_FILE=""
          
          find artifacts -type f -name "result-*.json" | sort -V | while IFS= read -r FILE; do
            FILE_COUNT=$((FILE_COUNT + 1))
            echo "[$FILE_COUNT] $FILE"
            if [ $FILE_COUNT -eq 1 ]; then
              FIRST_FILE="$FILE"
            fi
          done
          
          # 파일 목록을 임시 파일로 저장
          find artifacts -type f -name "result-*.json" | sort -V > /tmp/file_list.txt
          
          FILE_COUNT=$(wc -l < /tmp/file_list.txt)
          echo ""
          echo "Found $FILE_COUNT files to merge"
          
          if [ $FILE_COUNT -eq 0 ]; then
            echo "ERROR: No result files found!"
            exit 1
          fi
          
          # 첫 번째 파일로 시작
          FIRST_FILE=$(head -1 /tmp/file_list.txt)
          echo ""
          echo "=== Merge process started ==="
          echo "Base file: $FIRST_FILE"
          
          cp "$FIRST_FILE" result.json
          TOTAL=$(jq 'keys | length' result.json)
          echo "Initial model count: $TOTAL"
          echo ""
          
          # 나머지 파일 merge (sed로 라인 번호 제거)
          tail -n +2 /tmp/file_list.txt | nl | while IFS=$'\t' read -r STEP FILE; do
            echo "Step $STEP: Merging $(basename "$FILE")"
            
            # 현재 파일의 모델 수
            NEW_MODELS=$(jq 'keys | length' "$FILE")
            echo "  - New file has $NEW_MODELS models"
            
            # merge 실행
            jq -s '
              .[0] as $base |
              .[1] as $new |
              reduce ($new | keys[]) as $model (
                $base;
                if has($model) then
                  .[$model] += $new[$model]
                else
                  .[$model] = $new[$model]
                end
              )
            ' result.json "$FILE" > result_temp.json
            
            if [ ! -s result_temp.json ]; then
              echo "ERROR: Merge failed at step $STEP"
              exit 1
            fi
            
            mv result_temp.json result.json
            
            TOTAL=$(jq 'keys | length' result.json)
            echo "  - After merge: $TOTAL models total"
            echo ""
          done
          
          echo "=== Merge completed ==="
          echo "Final model count: $(jq 'keys | length' result.json)"
          
          # 최종 정렬
          jq --sort-keys '.' result.json > result_sorted.json
          mv result_sorted.json result.json
          
          # 최종 검증
          echo ""
          echo "=== Final validation ==="
          jq empty result.json && echo "✓ JSON is valid"
          
          cp result.json pats.json

      - name: Debug - Show merge summary
        run: |
          echo "=== Merge Summary ==="
          echo "Total models: $(jq 'keys | length' pats.json)"
          echo ""
          echo "=== Models and version counts ==="
          jq -r 'to_entries | map("\(.key): \(.value | keys | length) versions") | .[]' pats.json | head -20
          echo ""
          echo "=== Sample data (DS1019+) ==="
          jq '.["DS1019+"] | keys' pats.json 2>/dev/null || echo "DS1019+ not found"
          echo ""
          echo "=== File size ==="
          ls -lh pats.json

      - name: Upload merged result
        uses: actions/upload-artifact@v4
        with:
          name: dsm-md5-merged-final
          path: pats.json
