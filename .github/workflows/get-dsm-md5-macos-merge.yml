name: result.json - Get Synology DSM MD5 (macOS) - Merged

on:
  workflow_dispatch:

jobs:
  Get-md5:
    runs-on: macos-latest
    strategy:  
      matrix:
        dsm:
          - version: '6.2.4-25556'
            nano: false
          - version: '7.0.1-42218'
            nano: false
          - version: '7.1.1-42962'
            nano: true
          - version: '7.2-64570'
            nano: true
          - version: '7.2.1-69057'
            nano: true
          - version: '7.2.2-72806'
            nano: false
          - version: '7.3-81180'
            nano: false
          - version: '7.3.1-86003'
            nano: false
          - version: '7.3.2-86009'
            nano: false
          
    env:
      DSM_VERSION: ${{ matrix.dsm.version }}
      IS_NANO: ${{ matrix.dsm.nano }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare md5list file
        run: |
          DSM_VERSION_URL=$(echo "$DSM_VERSION" | sed 's/-/\//')

          if [ "$IS_NANO" = "true" ]; then
            ARCHIVE_URL="https://archive.synology.com/download/Os/DSM/${DSM_VERSION}-1-NanoPacked"
          else
            ARCHIVE_URL="https://archive.synology.com/download/Os/DSM/${DSM_VERSION}"
          fi
          
          echo "Fetching from $ARCHIVE_URL ..."
          
          curl -s "$ARCHIVE_URL" | \
            grep -oE 'DSM_[^"]+\.pat' | \          
            sed 's/%2B/+/g' | \
            sort -u | \
            head -300 | \
            while read filename; do
              if [ "$IS_NANO" = "true" ]; then
                echo "https://global.synologydownload.com/download/DSM/release/${DSM_VERSION_URL}-1/$filename"
              else
                echo "https://global.synologydownload.com/download/DSM/release/${DSM_VERSION_URL}/$filename"
              fi
            done > md5list
          
          echo "Generated $(wc -l < md5list) files"

      - name: Run MD5 Generation Script
        run: |
          chmod +x config/get_md5_json_macos.sh
          ./config/get_md5_json_macos.sh "$DSM_VERSION"

      - name: Validate and Rename JSON
        run: |
          jq empty result.json
          echo "result.json validated."
          cp result.json "result-${{ env.DSM_VERSION }}.json"          

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: dsm-md5-${{ env.DSM_VERSION }}
          path: |
            result-${{ env.DSM_VERSION }}.json
            md5list
